---
title: "Publications"
format:
  html:
    css: dtdd.css
---

Page built: `r format(Sys.time(), "%c")`

```{r, echo = FALSE}
format_bibentry <- function(x) {
  journal <- NULL
  if (!is.null(x$journal)) {
    journal <- paste0("*", unbrace(x$journal), "*")
  } else if (!is.null(x$booktitle)) {
    journal <- paste0("*", x$booktitle, "*")
  } else {
    journal <- ""
  }

  ref <- glue::glue(
    '
    **{ unbrace(x$title) }**, \\
    { x$formatted_authors }. \\
    { journal }, \\
    { x$year } \n
    '
  )

  pdf <- doi <- preprint <- pmc <- citations <- NULL
  if (!is.null(x$pdf) && !is.na(x$pdf)) {
    pdf <- glue::glue('[PDF](https://www.huber.embl.de/pub/pdf/{ x$pdf })')
  }
  if (!is.null(x$doi) && !is.na(x$doi) && !identical(x$doi, "NA")) {
    doi <- glue::glue('[DOI:{ x$doi }](https://doi.org/{ x$doi })')
  }
  if (!is.null(x$preprint) && !is.na(x$preprint)) {
    preprint <- glue::glue('[Preprint](https://doi.org/{ x$doi })')
  }
  if (!is.null(x$epmc) && !is.null(x$epmc)) {
    pmc <- glue::glue('[PMC]({ x$epmc })')
  }
  if (!is.null(x$citations) && !is.na(x$citations) && x$citations > 0) {
    citations <- glue::glue(
      '{ x$citations } citation(s) (source: OpenAlex, via the openalexR package).\n\n'
    )
  }

  links <- glue::glue_collapse(c(pdf, doi, preprint, pmc), sep = " - ")

  res <- glue::glue_collapse(c(ref, citations, links), sep = "<br>")

  return(res)
}

unbrace <- function(string) {
  gsub("[{}]", "", string)
}

format_and_highlight <- function(bibentry, group_members) {
  formatted_authors <- glue::glue_collapse(
    format(bibentry$author),
    sep = ", ",
    last = ", and "
  )

  members_when_published <- group_members |>
    dplyr::filter(
      is.na(start_year) | bibentry$year >= start_year,
      is.na(end_year) | bibentry$year <= end_year
    ) |>
    dplyr::pull(group_member)

  for (member in members_when_published) {
    formatted_authors <- gsub(
      paste0("(", member, ")"),
      "[\\1]{.underline}",
      formatted_authors
    )
  }

  formatted_authors <- gsub(
    "\\cocorr",
    "✉",
    formatted_authors,
    fixed = TRUE
  )
  formatted_authors <- gsub(
    "\\cofirst",
    "✷", # not an actual asterisk to avoid markdown issues
    formatted_authors,
    fixed = TRUE
  )

  bibentry$formatted_authors <- formatted_authors

  return(bibentry)
}
```

```{r, echo = FALSE}
group_members <- readr::read_csv(
  "group_members.csv",
  col_types = "ccc",
  comment = "#"
)
```

```{r, echo = FALSE, results='asis'}
publist <- bibtex::read.bib("lop.bib")

citations <- publist |>
  purrr::map_chr("doi") |>
  # 1 API request / 50 DOIs
  openalexR::oa_fetch(doi = _, entity = "works") |>
  dplyr::select(doi, cited_by_count) |>
  dplyr::mutate(doi = gsub("^https://doi.org/", "", doi))

publist <- publist |>
  purrr::map(function(x) {
    if (x$doi %in% citations$doi) {
      x$citations <- citations[
        citations$doi == x$doi,
        "cited_by_count",
        drop = TRUE
      ]
    } else {
      x$citations <- NA
    }
    return(x)
  })

# Sort elements by year
publist <- suppressWarnings(publist[
  order(
    purrr::map_int(publist, ~ as.integer(.x$year)),
    decreasing = TRUE
  )
])

formatted_publist <- publist |>
  purrr::map(format_and_highlight, group_members) |>
  purrr::map_chr(format_bibentry)

cat(formatted_publist, sep = "\n\n")
```

✷ indicates equal contributions <br>
✉ co-corresponding authorships